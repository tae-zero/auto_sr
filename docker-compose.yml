name: esg_mate

services:
  # Frontend (Next.js)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend
    ports:
      - "3001:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - /app/.next
      - /app/.pnpm-store
    environment:
      - NODE_ENV=development
      - NEXT_PUBLIC_API_URL=http://gateway:8080
      - WATCHPACK_POLLING=true
      - CHOKIDAR_USEPOLLING=true
    restart: always
    depends_on:
      gateway:
        condition: service_healthy
    networks:
      - app-network

  # Gateway (FastAPI)
  gateway:
    build: ./gateway
    container_name: gateway
    ports:
      - "8080:8080"
    volumes:
      - ./gateway:/app
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8080
      - LOG_LEVEL=INFO
      - GATEWAY_HOST=0.0.0.0
      - GATEWAY_PORT=8080
      - GATEWAY_RELOAD=false
      - SERVICE_DISCOVERY_TYPE=static
      - LOAD_BALANCER_TYPE=round_robin
      - REQUEST_TIMEOUT=30
      - HEALTH_CHECK_INTERVAL=30
      - CORS_ORIGINS=["*"]
      - CORS_ALLOW_CREDENTIALS=true
      - CORS_ALLOW_METHODS=["*"]
      - CORS_ALLOW_HEADERS=["*"]
      - INIT_DATABASE=true
      # JWT 설정
      - JWT_SECRET_KEY=esg-mate-super-secret-key-2025-railway-deployment-2025
      # Docker 로컬 환경 설정
      - RAILWAY_ENVIRONMENT=false
      - USE_RAILWAY_TCFD=false
      - USE_LOCAL_AUTH=true
      - USE_LOCAL_CHATBOT=true
      # Docker Service URLs 설정 (ServiceDiscovery 사용)
      - AUTH_SERVICE_URL=http://auth-service:8008
      - TCFD_SERVICE_URL=http://tcfd-service:8005
      - TCFD_REPORT_SERVICE_URL=http://tcfdreport-service:8004
      # Railway PostgreSQL 연결 (Public Network URL)
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
      # AI 및 LangChain 설정
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-2000}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.3}
      - VECTOR_DB_TYPE=${VECTOR_DB_TYPE:-chroma}
      - CHROMA_PERSIST_DIRECTORY=${CHROMA_PERSIST_DIRECTORY:-./chroma_db}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-20971520}
      - SUPPORTED_FILE_TYPES=${SUPPORTED_FILE_TYPES:-txt,pdf,docx,md}
    restart: always
    depends_on:
      redis:
        condition: service_healthy
      auth-service:
        condition: service_healthy
      tcfd-service:
        condition: service_healthy
      tcfdreport-service:
        condition: service_healthy
    dns:
      - 8.8.8.8
      - 8.8.4.4
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Chatbot Service (FastAPI)
  chatbot-service:
    build:
      context: ./service/chatbot-service
      dockerfile: Dockerfile
    container_name: chatbot-service
    ports:
      - "8001:8001"
    volumes:
      - ./service/chatbot-service:/app
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8001
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # TCFD Service (FastAPI + 재무정보 처리)
  tcfd-service:
    build:
      context: ./service/tcfd-service
      dockerfile: Dockerfile
    container_name: tcfd-service
    ports:
      - "8005:8005"
    volumes:
      - ./service/tcfd-service:/app
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8005
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - JWT_SECRET_KEY=esg-mate-super-secret-key-2025-railway-deployment-2025
      # Railway PostgreSQL 연결 (Public Network URL)
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # TCFD Report Service (FastAPI + LangChain + AI 보고서 생성)
  tcfdreport-service:
    build:
      context: ./service/tcfdreport-service
      dockerfile: Dockerfile
    container_name: tcfdreport-service
    ports:
      - "8004:8004"
    volumes:
      - ./service/tcfdreport-service:/app
      - tcfd_chroma_data:/app/chroma_db
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8004
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      # JWT 설정
      - JWT_SECRET_KEY=esg-mate-super-secret-key-2025-railway-deployment-2025
      # 데이터베이스 설정 추가
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
      # AI 및 LangChain 설정
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4}
      - OPENAI_MAX_TOKENS=${OPENAI_MAX_TOKENS:-2000}
      - OPENAI_TEMPERATURE=${OPENAI_TEMPERATURE:-0.3}
      - VECTOR_DB_TYPE=${VECTOR_DB_TYPE:-chroma}
      - CHROMA_PERSIST_DIRECTORY=${CHROMA_PERSIST_DIRECTORY:-./chroma_db}
      - MAX_FILE_SIZE=${MAX_FILE_SIZE:-20971520}
      - SUPPORTED_FILE_TYPES=${SUPPORTED_FILE_TYPES:-txt,pdf,docx,md}
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # GRI Service (FastAPI)
  gri-service:
    build:
      context: ./service/gri-service
      dockerfile: Dockerfile
    container_name: gri-service
    ports:
      - "8006:8006"
    volumes:
      - ./service/gri-service:/app
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8006
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - INIT_DATABASE=true
      # Railway PostgreSQL 연결
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
      - SECRET_KEY=${SECRET_KEY}
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Materiality Service (FastAPI)
  materiality-service:
    build:
      context: ./service/materiality-service
      dockerfile: Dockerfile
    container_name: materiality-service
    ports:
      - "8007:8007"
    volumes:
      - ./service/materiality-service:/app
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8007
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - INIT_DATABASE=true
      # Railway PostgreSQL 연결
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
      - SECRET_KEY=${SECRET_KEY}
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Auth Service (FastAPI)
  auth-service:
    build:
      context: ./service/auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    ports:
      - "8008:8008"
    volumes:
      - ./service/auth-service:/app
    environment:
      - SERVICE_HOST=0.0.0.0
      - SERVICE_PORT=8008
      - LOG_LEVEL=INFO
      - PYTHONUNBUFFERED=1
      - INIT_DATABASE=true
      # JWT 설정
      - JWT_SECRET_KEY=esg-mate-super-secret-key-2025-railway-deployment-2025
      # Railway PostgreSQL 연결 (Public Network URL)
      - DATABASE_URL=postgresql://postgres:YgIQJWEaQShbuQhRsAdVaeBUZatEgrQO@gondola.proxy.rlwy.net:46735/railway
    restart: always
    depends_on:
      - redis
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # Redis (캐싱 및 세션 저장)
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    networks:
      - app-network
    restart: always
    command: redis-server
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

volumes:
  tcfd_chroma_data:
    driver: local

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16